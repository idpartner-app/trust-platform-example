version: '3.8'

services:
  db:
    image: postgres:16.2
    volumes:
      - ./scripts/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
    restart: always
    ports:
      - "${SQL_PORT}:${SQL_PORT}"
    environment:
      POSTGRES_PASSWORD: ${SQL_PASSWORD}

  redis:
    image: redis:7.2.4
    restart: always
    ports:
      - "${REDIS_PORT}:${REDIS_PORT}"

  bank-services:
    image: mock-bank-services
    restart: always
    ports:
      - "${PORT}:${PORT}"
    environment:
      PORT: ${PORT}
      NODE_ENV: ${NODE_ENV}

      PGSSLMODE: ${PGSSLMODE}
      SQL_DATABASE: ${SQL_DATABASE}
      SQL_USER: ${SQL_USER}
      SQL_PASSWORD: ${SQL_PASSWORD}
      SQL_HOST: ${SQL_HOST}
      SQL_PORT: ${SQL_PORT}

      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}

      # Common Config
      BASE64_JWKS: ${BASE64_JWKS}
      BANK_SERVICES_URL: ${LOCAL_HOST_WITH_SCHEMA}:${PORT}
      COOKIE_DOMAIN: ${LOCAL_HOST}:${PORT}
      COOKIE_SECRET: ${COOKIE_SECRET}
      SENTRY_DSN: ${SENTRY_DSN}

      # OAuth2 Config
      OAUTH2_AUTHORIZATION_ISSUER_CLIENT_ID: ${CLIENT_ID}
      OAUTH2_AUTHORIZATION_ISSUER_CLIENT_SECRET: ${CLIENT_SECRET}
      OAUTH2_AUTHORIZATION_ISSUER_URL: ${LOCAL_HOST_WITH_SCHEMA}:${PORT}
      OAUTH2_AUTHORIZATION_PROXY_CALLBACK_URL: ${TRUST_PLATFORM_SERVICES_URL}/auth-adapter/v1/auth/callback

      # Push Notifications Config
      BANK_IDENTITY_BASE64_FIREBASE_PRIVATE_KEY: ${FIREBASE_BASE64_PRIVATE_KEY}
    depends_on:
      - db
      - redis

# services:
#   db:
#     image: postgres:14.3
#     volumes:
#       - ${PG_DATA_OVERRIDE-/tmp/idpartner/pg_data}:/var/lib/postgresql/data
#       - ./scripts/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
#     restart: always
#     ports:
#       - "5432:5432"
#     environment:
#       POSTGRES_PASSWORD: welcome1
# 
#   redis:
#     image: redis:6.2.6
#     restart: always
#     ports:
#       - "6379:6379"
# 
#   bank-services:
#     image: mock-bank-services
#     restart: always
#     ports:
#       - "9702:9702"
#     environment:
#       PORT: 9702
#       BASE64_JWKS: CHANGE_ME-BASE64_JWKS
#       OAUTH2_AUTHORIZATION_ISSUER_CLIENT_ID: CHANGE_ME-CLIENT_ID
#       OAUTH2_AUTHORIZATION_ISSUER_CLIENT_SECRET: CHANGE_ME-CLIENT_SECRET
#       OAUTH2_AUTHORIZATION_ISSUER_URL: http://docker.for.mac.localhost:9702
#       OAUTH2_AUTHORIZATION_PROXY_CALLBACK_URL: CHANGE_ME-TRUST_PLATFORM_SERVICES_NGROK/auth-adapter/v1/auth/callback
#       BANK_SERVICES_URL: http://docker.for.mac.localhost:9702
#       BANK_IDENTITY_BASE64_FIREBASE_PRIVATE_KEY: e30K
#       COOKIE_DOMAIN: docker.for.mac.localhost:9702
#       COOKIE_SECRET: CHANGE_ME-RANDOM_SECRET
#       PGSSLMODE: disable
#       SQL_DATABASE: idpartner
#       SQL_USER: postgres
#       SQL_PASSWORD: welcome1
#       SQL_HOST: docker.for.mac.localhost
#       SQL_PORT: 5432
#       REDIS_HOST: docker.for.mac.localhost
#       REDIS_PORT: 6379
#       SENTRY_DSN: https://xxx@yyy.ingest.sentry.io/000
#     depends_on:
#       - db
#       - redis

  trust-platform-services:
    image: idpartner-trust-platform-services
    restart: always
    ports:
      - "9501:9501"
    environment:
      # Common Config
      PORT: 9501
      BASE64_JWKS: CHANGE_ME-BASE64_JWKS
      TRUST_PLATFORM_SERVICE_URL: CHANGE_ME-TRUST_PLATFORM_SERVICES_NGROK

      # Database Config
      SQL_DATABASE: idpartner
      SQL_HOST: docker.for.mac.localhost
      SQL_PASSWORD: welcome1
      SQL_USER: postgres
      PGSSLMODE: disable

      # Redis Config
      REDIS_HOST: docker.for.mac.localhost
      # REDIS_PORT: 6379

      # Session Config
      COOKIE_DOMAIN: CHANGE_ME-TRUST_PLATFORM_SERVICES_NGROK_WITHOUT_SCHEME
      COOKIE_SECRET: CHANGE_ME-RANDOM_SECRET

      # Error Reporting Config
      SENTRY_DSN: https://xxx@yyy.ingest.sentry.io/000

      # IDP Services Config
      OIDC_PAYMENT_DETAILS_INFO_ENABLED: true
      OIDC_COOKIES_KEYS: CHANGE_ME-RANDOM_SECRET

      # (OIDC) Web, Redirect-based Flow Config
      AUTH_ADAPTER_OAUTH_PROTOCOL: oidc
      AUTH_ADAPTER_OAUTH_URL: http://docker.for.mac.localhost:9702/oauth2
      AUTH_ADAPTER_OAUTH_CLIENT_ID: CHANGE_ME-CLIENT_ID
      AUTH_ADAPTER_OAUTH_CLIENT_SECRET: CHANGE_ME-CLIENT_SECRET
      # AUTH_ADAPTER_OAUTH_PKCE_ENABLED: true

      # (OAuth2) Auth Config - Specify config below only if using OAuth2
      # AUTH_ADAPTER_OAUTH_PROTOCOL: oauth2
      # AUTH_ADAPTER_OAUTH_USERINFO_PATH: /me
      # AUTH_ADAPTER_OAUTH_TOKEN_PATH: /token
      # AUTH_ADAPTER_OAUTH_AUTHORIZATION_PATH: /auth

      # Mobile, Push-based Config
      BACKCHANNEL_MOBILE_APP_URL: CHANGE_ME-MOBILE_APP_URL
      BANK_AUTH_SERVICE_TOKEN_VERIFY_API: http://docker.for.mac.localhost:9702/v1/auth/verify
      BANK_USERS_SERVICE_API: http://docker.for.mac.localhost:9702/v1/users
      BANK_DEVICES_SERVICE_API: http://docker.for.mac.localhost:9702/v1/devices
      BANK_PUSH_AUTHENTICATIONS_SERVICE_API: http://docker.for.mac.localhost:9702/v1/push-authentications
      BANK_TRUSTED_PACKAGE_VERIFICATION_API: http://docker.for.mac.localhost:9702/v1/trusted-packages/verify
      BANK_TRUSTED_PACKAGE_VERIFICATION_ENABLED: true
    depends_on:
      - db
      - redis
